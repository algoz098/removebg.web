<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RemoveBG - RemoÃ§Ã£o de Fundo</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="Remova o fundo de suas imagens instantaneamente no navegador">
  <meta name="theme-color" content="#6c5ce7">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="RemoveBG">
  <meta name="mobile-web-app-capable" content="yes">
  
  <!-- Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512x512.png">
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192x192.png">
  
  <!-- Stylesheet -->
  <link rel="stylesheet" href="/src/css/main.css">
  <link rel="stylesheet" href="/src/css/splash.css">
</head>
<body>
  <!-- Splash Screen serÃ¡ inserida aqui pelo JavaScript -->
  <!-- Header de NavegaÃ§Ã£o -->
  <header class="nav-header">
    <div class="nav-container">
      <a href="/" class="nav-logo">ğŸ¨ RemoveBG</a>
      <nav class="nav-menu">
        <a href="/" class="nav-link active">InÃ­cio</a>
        <a href="/sobre.html" class="nav-link">Sobre</a>
      </nav>
    </div>
  </header>

  <!-- ConteÃºdo Principal -->
  <main class="main-content" style="display: none;">
    <div class="container">
      <h1>ğŸ¨ Remover Fundo de Imagem</h1>
      
      <!-- Indicador de progresso das pÃ¡ginas -->
      <div class="page-indicator">
        <div class="step active" data-step="1">1</div>
        <div class="step-line"></div>
        <div class="step" data-step="2">2</div>
        <div class="step-line"></div>
        <div class="step" data-step="3">3</div>
      </div>
    
    <!-- PÃ¡gina 1: Upload -->
    <div class="page" id="page-1">
      <h2>ğŸ“¸ Selecione sua imagem</h2>
      
      <!-- BotÃµes de teste DEBUG -->
      
      <div class="upload-area" id="upload-area">
        <input type="file" id="file-input" accept="image/*" />
        <div class="upload-text">
          <span class="upload-icon">ğŸ“¸</span>
          <span>Clique para selecionar uma imagem ou arraste aqui</span>
          <small>Suporta JPG, PNG, WEBP atÃ© 10MB</small>
        </div>
      </div>
    </div>
    
    <!-- PÃ¡gina 2: Preview e ConfirmaÃ§Ã£o -->
    <div class="page" id="page-2" style="display:none;">
      <h2>ğŸ“‹ Confirme sua imagem</h2>
      <div class="preview-container">
        <img id="preview" />
        <div class="image-info">
          <span id="image-size"></span>
          <span id="image-dimensions"></span>
        </div>
      </div>
      <div class="page-actions">
        <button class="btn-secondary" id="back-to-upload">â¬…ï¸ Voltar</button>
        <button class="btn-primary" id="proceed-to-process">Processar â¡ï¸</button>
      </div>
    </div>
    
    <!-- PÃ¡gina 3: Processamento e Resultado -->
    <div class="page" id="page-3" style="display:none;">
      <h2>âš¡ Processando imagem</h2>
      
      <!-- SeÃ§Ã£o de processamento -->
      <div id="processing-section">
        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
          <div id="progress-text">Carregando...</div>
        </div>
      </div>
      
      <!-- SeÃ§Ã£o de resultado -->
      <div id="result-section" style="display:none;">
        <div id="result" class="result"></div>
        <div class="page-actions">
          <button class="btn-secondary" id="process-new">ğŸ†• Nova Imagem</button>
          <button class="btn-secondary" id="back-to-preview">â¬…ï¸ Voltar</button>
        </div>
        </div>
      </div>
    </div>
  </main>  <div id="status"></div>
  
  
  <!-- Scripts - Splash deve carregar primeiro -->
  <script type="module" src="/src/js/splash-manager.js"></script>
  <script type="module" src="/src/js/pwa-advanced.js"></script>
  <script type="module" src="/src/js/navigation-manager.js"></script>
  <script type="module">
    let currentFile = null;
    let processedImageBlob = null;
    
    // FunÃ§Ã£o para processar imagem real
    async function processImageReal() {
      if (!currentFile) throw new Error('Nenhum arquivo selecionado');
      
      try {
        console.log('ï¿½ Processando imagem...');
        
        // Importar a biblioteca dinamicamente
        const { removeBackground } = await import('@imgly/background-removal');
        
        const imageBlob = await removeBackground(currentFile);
        
        // Criar URL para a imagem processada
        const processedUrl = URL.createObjectURL(imageBlob);
        processedImageBlob = imageBlob;
        
        return processedUrl;
      } catch (error) {
        console.error('âŒ Erro no processamento:', error);
        throw error;
      }
    }
    
    // FunÃ§Ã£o para download da imagem processada
    function downloadProcessedImage() {
      if (processedImageBlob) {
        const link = document.createElement('a');
        link.href = URL.createObjectURL(processedImageBlob);
        link.download = 'imagem_processada.png';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        console.log('ğŸ“¥ Download iniciado');
      } else {
        alert('âŒ Imagem processada nÃ£o estÃ¡ disponÃ­vel');
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      console.log('ğŸ”§ Iniciando webapp...');
      
      const fileInput = document.getElementById('file-input');
      const uploadArea = document.getElementById('upload-area');
      
      function showPage(pageNumber) {
        console.log('Mudando para pÃ¡gina', pageNumber);
        
        for (let i = 1; i <= 3; i++) {
          const page = document.getElementById('page-' + i);
          if (page) {
            page.style.display = 'none';
          }
        }
        
        const targetPage = document.getElementById('page-' + pageNumber);
        if (targetPage) {
          targetPage.style.display = 'block';
        }
        
        for (let i = 1; i <= 3; i++) {
          const step = document.querySelector('[data-step="' + i + '"]');
          if (step) {
            step.classList.remove('active', 'completed');
            if (i < pageNumber) {
              step.classList.add('completed');
            } else if (i === pageNumber) {
              step.classList.add('active');
            }
          }
        }
      }
      
      function createPreview(file) {
        console.log('Criando preview para:', file.name);
        
        // Salvar arquivo atual para processamento
        currentFile = file;
        
        const preview = document.getElementById('preview');
        const imageSize = document.getElementById('image-size');
        const imageDimensions = document.getElementById('image-dimensions');
        
        if (preview) {
          const url = URL.createObjectURL(file);
          preview.src = url;
          
          preview.onload = () => {
            if (imageDimensions) {
              imageDimensions.textContent = preview.naturalWidth + ' x ' + preview.naturalHeight + 'px';
            }
          };
        }
        
        if (imageSize) {
          const mb = (file.size / (1024 * 1024)).toFixed(2);
          imageSize.textContent = mb + ' MB';
        }
      }
      
      if (fileInput) {
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          
          if (file) {
            if (!file.type.startsWith('image/')) {
              alert('âŒ Por favor, selecione um arquivo de imagem');
              return;
            }
            
            console.log('âœ… Processando arquivo:', file.name);
            showPage(2);
            
            setTimeout(() => {
              createPreview(file);
            }, 100);
          }
        });
      }
      
      if (uploadArea) {
        uploadArea.addEventListener('click', () => {
          console.log('Ãrea clicada');
          if (fileInput) fileInput.click();
        });
      }
      
      setTimeout(() => {
        const backToUpload = document.getElementById('back-to-upload');
        const proceedToProcess = document.getElementById('proceed-to-process');
        
        if (backToUpload) {
          backToUpload.addEventListener('click', () => {
            showPage(1);
          });
        }
        
        if (proceedToProcess) {
          proceedToProcess.addEventListener('click', () => {
            console.log('ğŸš€ Iniciando processamento...');
            showPage(3);
            
            // Esconder seÃ§Ã£o de processamento e mostrar seÃ§Ã£o de resultado
            const processingSection = document.getElementById('processing-section');
            const resultSection = document.getElementById('result-section');
            const result = document.getElementById('result');
            
            console.log('ğŸ” Elementos encontrados:', {
              processingSection: !!processingSection,
              resultSection: !!resultSection,
              result: !!result
            });
            
            if (processingSection) {
              processingSection.style.display = 'block';
            }
            if (resultSection) {
              resultSection.style.display = 'none';
            }
            
            if (result) {
              // Primeiro mostrar na seÃ§Ã£o de processamento
              if (processingSection) {
                processingSection.innerHTML = '<div style="text-align: center;"><h3>ğŸ¨ Processando...</h3><p>â³ Aguarde...</p><div style="width: 100%; background: #f0f0f0; border-radius: 10px; margin: 20px 0;"><div style="width: 0%; height: 20px; background: linear-gradient(90deg, #6c5ce7, #a29bfe); border-radius: 10px; transition: width 2s ease;" id="progress-bar-anim"></div></div></div>';
                
                // Animar barra de progresso
                setTimeout(() => {
                  const progressBar = document.getElementById('progress-bar-anim');
                  if (progressBar) {
                    progressBar.style.width = '100%';
                  }
                }, 100);
              }
              
              // Processar imagem real
              processImageReal().then((processedImageUrl) => {
                console.log('ğŸ¯ Mostrando resultado...');
                
                // Esconder processamento e mostrar resultado
                if (processingSection) {
                  processingSection.style.display = 'none';
                }
                if (resultSection) {
                  resultSection.style.display = 'block';
                }
                
                const preview = document.getElementById('preview');
                if (preview && preview.src && processedImageUrl) {
                  result.innerHTML = '<div style="text-align: center;"><h3>âœ¨ Resultado</h3><div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin: 20px 0;"><div><h4>ğŸ“¸ Original</h4><img src="' + preview.src + '" style="max-width: 250px; border: 2px solid #ddd; border-radius: 10px;"></div><div><h4>ğŸ¨ Processada</h4><img src="' + processedImageUrl + '" style="max-width: 250px; border: 2px solid #ddd; border-radius: 10px; background: repeating-linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%), repeating-linear-gradient(-45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%); background-size: 20px 20px;"></div></div></div><div style="margin-top: 20px;"><button onclick="downloadProcessedImage()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px;">ğŸ“¥ Download PNG</button><button onclick="location.reload()" style="background: #6c5ce7; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px;">ğŸ†• Nova Imagem</button></div></div>';
                  console.log('âœ… Resultado carregado com sucesso!');
                } else {
                  console.error('âŒ Erro no processamento');
                  result.innerHTML = '<div style="text-align: center; color: red;"><h3>âŒ Erro</h3><p>Falha no processamento da imagem</p><button onclick="location.reload()" style="background: #6c5ce7; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">ğŸ”„ Tentar Novamente</button></div>';
                }
              }).catch((error) => {
                console.error('âŒ Erro no processamento:', error);
                if (processingSection) {
                  processingSection.style.display = 'none';
                }
                if (resultSection) {
                  resultSection.style.display = 'block';
                }
                result.innerHTML = '<div style="text-align: center; color: red;"><h3>âŒ Erro</h3><p>Falha no processamento: ' + error.message + '</p><button onclick="location.reload()" style="background: #6c5ce7; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">ğŸ”„ Tentar Novamente</button></div>';
              });
            } else {
              console.error('âŒ Elemento result nÃ£o encontrado!');
            }
          });
        }
      }, 500);
      
      // Garantir que o conteÃºdo principal esteja visÃ­vel APENAS apÃ³s o splash terminar
      // const mainContent = document.querySelector('.main-content');
      // if (mainContent) {
      //   mainContent.style.display = 'block';
      //   console.log('âœ… Main content tornado visÃ­vel');
      // }
      
      showPage(1);
    });
  </script>
</body>
</html>

// RemoveBG WebApp - Arquivo principal
import { UIManager } from './ui-manager.js';
import { FileUploadManager } from './file-upload.js';
import { BackgroundProcessor } from './background-processor.js';
import { modelPreloader } from './model-preloader.js';
import { cacheManager } from './cache-manager.js';
import { toast } from './toast.js';
import { globalState } from './global-state.js';
// import './network-monitor.js'; // Desabilitado temporariamente

class RemoveBGApp {
  constructor() {
    this.uiManager = null;
    this.fileUploadManager = null;
    this.backgroundProcessor = null;
    this.isReady = false;
    
    // Aguardar splash screen terminar
    this.waitForAppReady();
  }

  async waitForAppReady() {
    console.log('‚è≥ Aguardando splash screen terminar...');
    
    // Verificar estado global primeiro
    const stats = globalState.getStats();
    console.log('üåç Estado global na inicializa√ß√£o do main:', stats);
    
    // Se splash j√° foi completado, inicializar imediatamente
    if (globalState.isSplashCompleted()) {
      console.log('‚ö° Splash j√° completado globalmente, inicializando app imediatamente...');
      setTimeout(() => this.init(), 100);
      return;
    }
    
    // Escutar evento de app pronto
    window.addEventListener('appReady', () => {
      console.log('üîî Evento appReady recebido!');
      console.log('‚úÖ Splash screen terminou, inicializando app...');
      this.init();
    });
    
    // Timeout de seguran√ßa muito mais curto para debug
    setTimeout(() => {
      if (!this.isReady) {
        console.warn('‚ö†Ô∏è Timeout: for√ßando inicializa√ß√£o do app ap√≥s 3 segundos');
        this.init();
      }
    }, 3000); // 3 segundos apenas para debug
    
    // Adicionar bot√£o de inicializa√ß√£o manual para debug
    setTimeout(() => {
      if (!this.isReady) {
        console.log('üîß Criando bot√£o de debug para inicializa√ß√£o manual...');
      }
    }, 1000);
  }
  
  async init() {
    console.log('üöÄ Inicializando RemoveBG App...');
    
    // Verificar se j√° foi inicializado
    if (this.isReady) {
      console.warn('‚ö†Ô∏è App j√° foi inicializado! Ignorando nova inicializa√ß√£o.');
      return;
    }
    
    // Verificar se splash ainda existe
    const splashElement = document.getElementById('splash-screen');
    if (splashElement) {
      console.warn('‚ö†Ô∏è Splash screen ainda existe no DOM!', splashElement);
    } else {
      console.log('‚úÖ Splash screen removido do DOM');
    }
    
    // Verificar se main-content est√° vis√≠vel
    const mainContent = document.querySelector('.main-content');
    if (mainContent) {
      const styles = window.getComputedStyle(mainContent);
      console.log('üìä Main content styles:', {
        display: styles.display,
        opacity: styles.opacity,
        visibility: styles.visibility
      });
    }
    
    // Aguardar um pouco para garantir que DOM est√° pronto
    await new Promise(resolve => setTimeout(resolve, 100));
    
    // Verificar elementos essenciais
    const fileInput = document.getElementById('file-input');
    const uploadArea = document.getElementById('upload-area');
    const page1 = document.getElementById('page-1');
    const page2 = document.getElementById('page-2');
    
    console.log('üéØ Elementos do DOM verificados:', {
      fileInput: !!fileInput,
      uploadArea: !!uploadArea,
      page1: !!page1,
      page2: !!page2
    });
    
    if (!fileInput || !uploadArea) {
      console.error('‚ùå Elementos essenciais n√£o encontrados! Aguardando mais...');
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    this.uiManager = new UIManager();
    this.fileUploadManager = new FileUploadManager(this.uiManager);
    this.backgroundProcessor = new BackgroundProcessor(this.uiManager);
    
    this.setupNavigationListeners();
    this.setupCacheManagement();
    this.uiManager.updateStatus('‚úÖ Pronto para processar imagens!');
    this.uiManager.showPage(1);
    
    this.isReady = true;
    
    // Adicionar fun√ß√µes de teste globais
    window.debugApp = {
      testFileInput: () => {
        console.log('üß™ Testando input de arquivo...');
        const fileInput = document.getElementById('file-input');
        if (fileInput) {
          console.log('‚úÖ Input encontrado, simulando click...');
          fileInput.click();
        } else {
          console.error('‚ùå Input n√£o encontrado!');
        }
      },
      
      testUploadArea: () => {
        console.log('üß™ Testando √°rea de upload...');
        const uploadArea = document.getElementById('upload-area');
        if (uploadArea) {
          console.log('‚úÖ √Årea encontrada, simulando click...');
          uploadArea.click();
        } else {
          console.error('‚ùå √Årea n√£o encontrada!');
        }
      },
      
      showPage: (pageNumber) => {
        console.log(`üß™ Testando mudan√ßa para p√°gina ${pageNumber}...`);
        this.uiManager.showPage(pageNumber);
      },
      
      getElements: () => {
        return {
          fileInput: document.getElementById('file-input'),
          uploadArea: document.getElementById('upload-area'),
          page1: document.getElementById('page-1'),
          page2: document.getElementById('page-2'),
          page3: document.getElementById('page-3'),
          mainContent: document.querySelector('.main-content')
        };
      }
    };
    
    console.log('üß™ Fun√ß√µes de debug dispon√≠veis em window.debugApp');
    
    // Fun√ß√£o de teste global mais simples
    window.debugTest = () => {
      console.log('üß™ DEBUG TEST: Iniciando teste de upload...');
      
      // Verificar estado da aplica√ß√£o
      console.log('üîç Estado da aplica√ß√£o:', {
        app: !!window.removeBGApp,
        ready: window.removeBGApp?.isReady,
        uiManager: !!window.removeBGApp?.uiManager,
        fileUploadManager: !!window.removeBGApp?.fileUploadManager
      });
      
      // Verificar elementos DOM
      const elements = {
        fileInput: document.getElementById('file-input'),
        uploadArea: document.getElementById('upload-area'),
        page1: document.getElementById('page-1'),
        page2: document.getElementById('page-2'),
        mainContent: document.querySelector('.main-content')
      };
      
      console.log('üéØ Elementos DOM:', elements);
      
      // Testar click no fileInput diretamente
      if (elements.fileInput) {
        console.log('üñ±Ô∏è Testando click direto no input...');
        elements.fileInput.click();
      }
    };
    
    // Fun√ß√£o para testar upload simples
    window.testUpload = () => {
      console.log('üìÅ Testando click na √°rea de upload...');
      const uploadArea = document.getElementById('upload-area');
      const fileInput = document.getElementById('file-input');
      
      console.log('üîç Elementos:', {
        uploadArea: !!uploadArea,
        fileInput: !!fileInput
      });
      
      if (uploadArea) {
        console.log('üñ±Ô∏è Clicando na √°rea de upload...');
        uploadArea.click();
      } else if (fileInput) {
        console.log('üñ±Ô∏è Clicando diretamente no input...');
        fileInput.click();
      }
    };
      
      console.log('üéØ Elementos DOM:', Object.keys(elements).reduce((acc, key) => {
        acc[key] = !!elements[key];
        return acc;
      }, {}));
      
      // Tentar simular upload
      const fileInput = elements.fileInput;
      if (fileInput) {
        console.log('‚úÖ Simulando click no input...');
        fileInput.click();
      } else {
        console.error('‚ùå Input n√£o encontrado!');
      }
    };
    
    // Toast de boas-vindas mais discreto (modelo j√° foi carregado)
    setTimeout(() => {
      toast.success('üéâ RemoveBG pronto! Modelo de IA carregado e funcional.', 4000);
    }, 500);
    
    console.log('‚úÖ RemoveBG App inicializado com sucesso!');
  }

  setupNavigationListeners() {
    // Bot√µes de navega√ß√£o
    const backToUpload = document.getElementById('back-to-upload');
    const proceedToProcess = document.getElementById('proceed-to-process');
    const processNew = document.getElementById('process-new');
    const backToPreview = document.getElementById('back-to-preview');

    // Voltar para upload
    if (backToUpload) {
      backToUpload.addEventListener('click', () => {
        this.uiManager.showPage(1);
        this.uiManager.clearPreview();
        this.fileUploadManager.clearSelectedFile();
      });
    }

    // Prosseguir para processamento
    if (proceedToProcess) {
      proceedToProcess.addEventListener('click', async () => {
        const file = this.fileUploadManager.getSelectedFile();
        if (!file) {
          this.uiManager.updateStatus('‚ùå Nenhum arquivo selecionado', 'error');
          return;
        }

        // Se o modelo n√£o estiver carregado ainda, iniciar carregamento imediatamente
        if (!modelPreloader.isReady() && !modelPreloader.isPreloading) {
          toast.info('üöÄ Iniciando carregamento do modelo...');
          modelPreloader.startPreloading();
        }

        this.uiManager.showPage(3);
        this.uiManager.toggleProcessingSections(true);
        
        try {
          await this.backgroundProcessor.processImage(file);
        } catch (error) {
          this.uiManager.showPage(2); // Voltar para preview em caso de erro
        }
      });
    }

    // Processar nova imagem
    if (processNew) {
      processNew.addEventListener('click', () => {
        this.uiManager.showPage(1);
        this.uiManager.clearPreview();
        this.uiManager.clearResults();
        this.fileUploadManager.clearSelectedFile();
      });
    }

    // Voltar para preview
    if (backToPreview) {
      backToPreview.addEventListener('click', () => {
        this.uiManager.showPage(2);
        this.uiManager.clearResults();
      });
    }
  }

  /**
   * Configura gerenciamento de cache e controles avan√ßados
   */
  setupCacheManagement() {
    // Escutar mensagens do service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', (event) => {
        const { data } = event;
        
        if (data.type === 'AI_CACHE_HIT') {
          console.log('üöÄ Cache hit do SW:', data.url);
        } else if (data.type === 'AI_DOWNLOAD_START') {
          console.log('üì• SW iniciando download:', data.url);
        } else if (data.type === 'AI_CACHE_STORED') {
          console.log('üíæ SW armazenou no cache:', data.url);
        }
      });

      // Registrar novo service worker (desabilitado para debug)
      // this.registerServiceWorker();
      console.log('‚ö†Ô∏è Service Worker desabilitado para debug');
    }

    // Adicionar controles de cache na interface (opcional)
    this.addCacheControls();
  }

  /**
   * Registra o service worker avan√ßado
   */
  async registerServiceWorker() {
    try {
      // Registrar com escopo correto
      const registration = await navigator.serviceWorker.register('/src/js/sw-advanced.js', {
        scope: '/src/js/'
      });
      console.log('‚úÖ Service Worker avan√ßado registrado');
      
      // Verificar atualiza√ß√µes
      registration.addEventListener('updatefound', () => {
        console.log('üîÑ Nova vers√£o do Service Worker dispon√≠vel');
      });
      
    } catch (error) {
      console.warn('‚ö†Ô∏è Falha ao registrar Service Worker:', error);
      // Tentar registrar SW simples como fallback
      try {
        await navigator.serviceWorker.register('/src/js/sw.js', {
          scope: '/src/js/'
        });
        console.log('‚úÖ Service Worker simples registrado como fallback');
      } catch (fallbackError) {
        console.warn('‚ö†Ô∏è Falha ao registrar SW fallback:', fallbackError);
      }
    }
  }

  /**
   * Adiciona controles de cache na interface
   */
  addCacheControls() {
    // Adicionar bot√£o de estat√≠sticas do cache no rodap√©
    const footer = document.querySelector('footer') || document.body;
    
    const cacheControls = document.createElement('div');
    cacheControls.innerHTML = `
      <div style="
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 8px;
        font-size: 12px;
        z-index: 1000;
        display: none;
      " id="cache-stats">
        <div id="cache-info">Cache: Carregando...</div>
        <button onclick="window.removeBGApp.showCacheStats()" style="
          background: #007bff;
          color: white;
          border: none;
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 11px;
          margin-top: 5px;
          cursor: pointer;
        ">üìä Stats</button>
        <button onclick="window.removeBGApp.clearCache()" style="
          background: #dc3545;
          color: white;
          border: none;
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 11px;
          margin-top: 5px;
          margin-left: 5px;
          cursor: pointer;
        ">üóëÔ∏è Limpar</button>
      </div>
    `;
    
    footer.appendChild(cacheControls);
    
    // Mostrar controles ap√≥s alguns segundos
    setTimeout(() => {
      document.getElementById('cache-stats').style.display = 'block';
      this.updateCacheInfo();
    }, 5000);
  }

  /**
   * Atualiza informa√ß√µes do cache na interface
   */
  async updateCacheInfo() {
    try {
      const stats = await cacheManager.getCacheStats();
      const cacheInfo = document.getElementById('cache-info');
      if (cacheInfo) {
        cacheInfo.textContent = `Cache: ${stats.count} recursos (${stats.formattedSize})`;
      }
    } catch (error) {
      console.warn('Erro ao atualizar info do cache:', error);
    }
  }

  /**
   * Mostra estat√≠sticas detalhadas do cache
   */
  async showCacheStats() {
    const stats = await cacheManager.getCacheStats();
    const types = Object.entries(stats.types).map(([type, count]) => `${type}: ${count}`).join('\n');
    
    alert(`üìä Estat√≠sticas do Cache:\n\n` +
          `Total de recursos: ${stats.count}\n` +
          `Tamanho total: ${stats.formattedSize}\n\n` +
          `Tipos de recursos:\n${types || 'Nenhum recurso ainda'}`);
  }

  /**
   * Limpa o cache de recursos
   */
  async clearCache() {
    if (confirm('üóëÔ∏è Tem certeza que deseja limpar o cache?\n\nIsso for√ßar√° o download dos recursos novamente.')) {
      const success = await cacheManager.clearCache();
      if (success) {
        this.updateCacheInfo();
        // Tamb√©m limpar cache do service worker
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage({ type: 'CLEAR_AI_CACHE' });
        }
      }
    }
  }
}

// Expor globalmente para os bot√µes inline
window.removeBGApp = null;

// Inicializar app quando DOM estiver pronto
document.addEventListener('DOMContentLoaded', () => {
  console.log('üìÑ DOM carregado, criando app...');
  window.removeBGApp = new RemoveBGApp();
});
